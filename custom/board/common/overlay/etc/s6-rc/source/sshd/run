#!/usr/bin/execlineb -P

# Check if /etc/dropbear is a symbolic link.
# If true and it can be removed, then rootfs is R/W, so create directory
# for persistent storage
# Otherwise, rootfs is R/O, so create a directory in volatile storage
if
{
   backtick -in CONF_DIR { readlink /etc/dropbear }
   import -u CONF_DIR
   if { s6-test -L /etc/dropbear -a $CONF_DIR = /var/run/dropbear }
     ifthenelse { s6-rmrf /etc/dropbear }
                { s6-mkdir -p /etc/dropbear }
                { s6-mkdir -p $CONF_DIR }
}

fdmove -c 2 1
fdmove 1 3
s6-tcpserver4 -v 2 -1 -- 0.0.0.0 22
s6-tcpserver-access -v 2 -DRl0 -t 5000 -i data/rules --
dropbear -i -K 60 -R
